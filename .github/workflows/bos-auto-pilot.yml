# BOS Auto-Pilot - Gera√ß√£o Di√°ria de Insights
# Este workflow executa automaticamente todos os dias √†s 6h (hor√°rio de S√£o Paulo)

name: BOS Daily Insights Generator

on:
  schedule:
    # Executa √†s 9h UTC = 6h Bras√≠lia (GMT-3)
    - cron: '0 9 * * *'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  generate-insights:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install @supabase/supabase-js dotenv
      
      - name: Generate BOS Insights
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node << 'EOF'
          const { createClient } = require('@supabase/supabase-js');
          
          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );
          
          async function generateInsights() {
            console.log('ü§ñ BOS Auto-Pilot iniciado...');
            
            // Buscar todas as cl√≠nicas ativas
            const { data: clinics, error } = await supabase
              .from('clinics')
              .select('id, name')
              .or('status.eq.ACTIVE,status.is.null');
            
            if (error) throw error;
            
            console.log(`üìã ${clinics.length} cl√≠nicas encontradas`);
            
            // Gerar insights para cada cl√≠nica
            for (const clinic of clinics) {
              console.log(`‚öôÔ∏è  Processando: ${clinic.name}...`);
              
              const { error: genError } = await supabase.rpc(
                'fn_generate_recovery_insights',
                { p_clinic_id: clinic.id }
              );
              
              if (genError) {
                console.error(`‚ùå Erro em ${clinic.name}:`, genError);
              } else {
                console.log(`‚úÖ Insights gerados para ${clinic.name}`);
              }
            }
            
            console.log('üéØ BOS Auto-Pilot conclu√≠do!');
          }
          
          generateInsights().catch(console.error);
          EOF
      
      - name: Notify completion
        run: echo "‚úÖ Insights gerados com sucesso!"
